{% extends "base.html" %}

{% block content %}
<div class="configurazione-container">
    <h2>Configurazione Magazzino</h2>
    <!-- Sezione per l'ordinamento delle bottiglie -->
    <div class="ordinamento-container" style="margin-bottom: 20px;">
        <form method="GET" action="{{ url_for('configurazione') }}">
            <label for="sort_by">Ordina per</label>
            <select id="sort_by" name="sort_by">
                <option value="costo_desc" {% if request.args.get('sort_by') == 'costo_desc' %}selected{% endif %}>Costo (Decrescente)</option>
                <option value="costo_asc" {% if request.args.get('sort_by') == 'costo_asc' %}selected{% endif %}>Costo (Crescente)</option>
                <option value="quantita_desc" {% if request.args.get('sort_by') == 'quantita_desc' %}selected{% endif %}>Quantità (Decrescente)</option>
                <option value="quantita_asc" {% if request.args.get('sort_by') == 'quantita_asc' %}selected{% endif %}>Quantità (Crescente)</option>
                <option value="prezzo_base_desc" {% if request.args.get('sort_by') == 'prezzo_base_desc' %}selected{% endif %}>Prezzo Base (Decrescente)</option>
                <option value="prezzo_base_asc" {% if request.args.get('sort_by') == 'prezzo_base_asc' %}selected{% endif %}>Prezzo Base (Crescente)</option>
            </select>

            <!-- Menù a discesa per decidere quante bottiglie visualizzare per pagina -->
            <label for="items_per_page">Bottiglie per Pagina</label>
            <select id="items_per_page" name="items_per_page">
                <option value="10" {% if request.args.get('items_per_page') == '10' %}selected{% endif %}>10</option>
                <option value="20" {% if request.args.get('items_per_page') == '20' %}selected{% endif %}>20</option>
                <option value="30" {% if request.args.get('items_per_page') == '30' %}selected{% endif %}>30</option>
                <option value="50" {% if request.args.get('items_per_page') == '50' %}selected{% endif %}>50</option>
            </select>

            <button type="submit">Applica Ordinamento</button>
        </form>
    </div>

    <!-- Bottone per mostrare/nascondere il form di inserimento -->
    <button type="button" onclick="toggleInserimento()">Aggiungi Nuova Bottiglia</button>

    <!-- Form per inserire una nuova bottiglia nel magazzino -->
    <div id="inserimento-container" style="display:none; margin-top: 20px;">
        <form method="POST" action="{{ url_for('configurazione') }}">
            <label for="descrizione">Descrizione</label>
            <input type="text" id="descrizione" name="descrizione" required>

            <label for="prezzo_base">Prezzo Base (€)</label>
            <input type="number" id="prezzo_base" name="prezzo_base" step="0.01" required>

            <label for="costo">Costo (€)</label>
            <input type="number" id="costo" name="costo" step="0.01" required>

            <label for="categoria">Categoria</label>
            <select id="categoria" name="categoria">
                <option value="">Seleziona una categoria</option>
                <option value="Analcolico">Analcolico</option>
                <option value="Birra">Birra</option>
                <option value="Food | Dolce">Food | Dolce</option>
                <option value="Food | Salato">Food | Salato</option>
                <option value="Olio">Olio</option>
                <option value="Sparkling">Sparkling</option>
                <option value="Spirit">Spirit</option>
                <option value="Tabella">Tabella</option>
                <option value="Vino Bianco">Vino Bianco</option>
                <option value="Vino Dolce">Vino Dolce</option>
                <option value="Vino Rosato">Vino Rosato</option>
                <option value="Vino Rosso">Vino Rosso</option>
            </select>

            <label for="codice_a_barre">Codice a Barre</label>
            <input type="text" id="codice_a_barre" name="codice_a_barre">

            <label for="id_interno">ID Interno</label>
            <input type="text" id="id_interno" name="id_interno">

            <!-- Gestione delle collocazioni e quantità -->
            <div id="collocazioni-container">
                <div class="collocazione-item">
                    <label for="collocazione_1">Collocazione 1</label>
                    <select id="collocazione_1" name="collocazione_1">
                        <option value="">Seleziona una collocazione</option>
                        <option value="Sala Principale">Sala Principale</option>
                        <option value="Sala Secondaria">Sala Secondaria</option>
                        <option value="Soppalco">Soppalco</option>
                    </select>

                    <label for="collocazione_2">Collocazione 2</label>
                    <select id="collocazione_2" name="collocazione_2">
                        <option value="">Seleziona una collocazione</option>
                    </select>

                    <label for="quantita">Quantità</label>
                    <input type="number" id="quantita" name="quantita" min="1" required>
                </div>
            </div>

            <button type="button" onclick="aggiungiCollocazione()">Aggiungi Collocazione</button>
            <button type="submit">Aggiungi Bottiglia</button>
        </form>
    </div>

    <!-- Form per gestire le azioni di massa -->
    <form id="mass-action-form" method="POST" action="{{ url_for('elimina_massiva_configurazione') }}">
        <!-- Lista delle bottiglie già inserite -->
        <div class="bottiglie-list">
            <h3>Bottiglie nel Magazzino</h3>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Descrizione</th>
                        <th>Categoria</th>
                        <th>Prezzo Base (€)</th>
                        <th>Costo (€)</th>
                        <th>Quantità Totale</th>
                        <th>Collocazioni</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bottiglia in bottiglie_info %}
                    <tr>
                        <td><input type="checkbox" name="bottiglia_ids" value="{{ bottiglia._id }}"></td>
                        <td>{{ bottiglia.descrizione }}</td>
                        <td>{{ bottiglia.categoria }}</td>
                        <td>{{ bottiglia.prezzo_base }}€</td>
                        <td>{{ bottiglia.costo }}€</td>
                        <td>{{ bottiglia.quantita_totale }}</td>
                        <td>
                            <ul>
                                {% for collocazione in bottiglia.collocazioni %}
                                <li>{{ collocazione.collocazione_1 }} / {{ collocazione.collocazione_2 }}: {{ collocazione.quantita }} bottiglie</li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>
                            <a href="{{ url_for('modifica_configurazione', id=bottiglia._id) }}">Modifica</a>
                            <a href="{{ url_for('elimina_configurazione', id=bottiglia._id) }}" onclick="return confirm('Sei sicuro di voler eliminare questa bottiglia?')">Elimina</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pulsante per l'eliminazione di massa -->
            <button type="submit" class="mass-action-button" onclick="return confirm('Sei sicuro di voler eliminare le bottiglie selezionate?')">Elimina Selezionati</button>
        </div>
    </form>

    <!-- Paginazione -->
    <div class="pagination">
        {% if current_page > 1 %}
        <a href="{{ url_for('configurazione', page=current_page-1, sort_by=request.args.get('sort_by'), items_per_page=request.args.get('items_per_page')) }}">&laquo; Pagina Precedente</a>
        {% endif %}
        <span>Pagina {{ current_page }} di {{ total_pages }}</span>
        {% if current_page < total_pages %}
        <a href="{{ url_for('configurazione', page=current_page+1, sort_by=request.args.get('sort_by'), items_per_page=request.args.get('items_per_page')) }}">Pagina Successiva &raquo;</a>
        {% endif %}
    </div>
</div>

<script>
    function toggleInserimento() {
        var inserimentoContainer = document.getElementById('inserimento-container');
        if (inserimentoContainer.style.display === 'none') {
            inserimentoContainer.style.display = 'block';
        } else {
            inserimentoContainer.style.display = 'none';
        }
    }

    function aggiungiCollocazione() {
        const container = document.getElementById('collocazioni-container');
        const newIndex = container.children.length + 1;

        const newCollocazione = document.createElement('div');
        newCollocazione.classList.add('collocazione-item');

        newCollocazione.innerHTML = `
            <label for="collocazione_1_${newIndex}">Collocazione 1</label>
            <select id="collocazione_1_${newIndex}" name="collocazione_1" onchange="updateCollocazione2(this)">
                <option value="">Seleziona una collocazione</option>
                <option value="Sala Principale">Sala Principale</option>
                <option value="Sala Secondaria">Sala Secondaria</option>
                <option value="Soppalco">Soppalco</option>
            </select>

            <label for="collocazione_2_${newIndex}">Collocazione 2</label>
            <select id="collocazione_2_${newIndex}" name="collocazione_2">
                <option value="">Seleziona una collocazione</option>
            </select>

            <label for="quantita_${newIndex}">Quantità</label>
            <input type="number" id="quantita_${newIndex}" name="quantita" min="1" required>
        `;

        container.appendChild(newCollocazione);
    }

    function updateCollocazione2(selectElement) {
        var collocazione1 = selectElement.value;
        var collocazione2 = selectElement.closest('.collocazione-item').querySelector('select[name="collocazione_2"]');

        collocazione2.innerHTML = '';

        if (collocazione1 === 'Sala Principale') {
            collocazione2.add(new Option('Frigo', 'Frigo'));
            collocazione2.add(new Option('Scaffali', 'Scaffali'));
        } else if (collocazione1 === 'Sala Secondaria' || collocazione1 === 'Soppalco') {
            collocazione2.add(new Option('Scaffali', 'Scaffali'));
        }
    }

    // Seleziona/Deseleziona tutti i checkbox
    document.getElementById('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="bottiglia_ids"]');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    document.querySelectorAll('select[name="collocazione_1"]').forEach(function(selectElement) {
        selectElement.addEventListener('change', function() {
            updateCollocazione2(selectElement);
        });
    });
</script>
{% endblock %}
