{% extends "base.html" %}

{% block content %}
<div class="modifica-container">
    <h2>Modifica Bottiglia</h2>

    <form method="POST" action="{{ url_for('modifica_configurazione', id=bottiglia._id) }}">
        <label for="descrizione">Descrizione</label>
        <input type="text" id="descrizione" name="descrizione" value="{{ bottiglia.descrizione }}" required>

        <label for="prezzo_base">Prezzo Base (€)</label>
        <input type="number" id="prezzo_base" name="prezzo_base" step="0.01" value="{{ bottiglia.prezzo_base }}" required>

        <label for="costo">Costo (€)</label>
        <input type="number" id="costo" name="costo" step="0.01" value="{{ bottiglia.costo }}" required>

        <label for="categoria">Categoria</label>
        <select id="categoria" name="categoria">
            <option value="Analcolico" {% if bottiglia.categoria == 'Analcolico' %}selected{% endif %}>Analcolico</option>
            <option value="Birra" {% if bottiglia.categoria == 'Birra' %}selected{% endif %}>Birra</option>
            <option value="Food | Dolce" {% if bottiglia.categoria == 'Food | Dolce' %}selected{% endif %}>Food | Dolce</option>
            <option value="Food | Salato" {% if bottiglia.categoria == 'Food | Salato' %}selected{% endif %}>Food | Salato</option>
            <option value="Olio" {% if bottiglia.categoria == 'Olio' %}selected{% endif %}>Olio</option>
            <option value="Sparkling" {% if bottiglia.categoria == 'Sparkling' %}selected{% endif %}>Sparkling</option>
            <option value="Spirit" {% if bottiglia.categoria == 'Spirit' %}selected{% endif %}>Spirit</option>
            <option value="Tabella" {% if bottiglia.categoria == 'Tabella' %}selected{% endif %}>Tabella</option>
            <option value="Vino Bianco" {% if bottiglia.categoria == 'Vino Bianco' %}selected{% endif %}>Vino Bianco</option>
            <option value="Vino Dolce" {% if bottiglia.categoria == 'Vino Dolce' %}selected{% endif %}>Vino Dolce</option>
            <option value="Vino Rosato" {% if bottiglia.categoria == 'Vino Rosato' %}selected{% endif %}>Vino Rosato</option>
            <option value="Vino Rosso" {% if bottiglia.categoria == 'Vino Rosso' %}selected{% endif %}>Vino Rosso</option>
        </select>

        <label for="codice_a_barre">Codice a Barre</label>
        <input type="text" id="codice_a_barre" name="codice_a_barre" value="{{ bottiglia.codice_a_barre }}">

        <label for="id_interno">ID Interno</label>
        <input type="text" id="id_interno" name="id_interno" value="{{ bottiglia.id_interno }}">

        <!-- Gestione delle collocazioni e quantità -->
        <div id="collocazioni-container">
            {% for collocazione in bottiglia.collocazioni %}
            <div class="collocazione-item">
                <label for="collocazione_1_{{ loop.index }}">Collocazione 1</label>
                <select id="collocazione_1_{{ loop.index }}" name="collocazione_1">
                    <option value="Sala Principale" {% if collocazione.collocazione_1 == 'Sala Principale' %}selected{% endif %}>Sala Principale</option>
                    <option value="Sala Secondaria" {% if collocazione.collocazione_1 == 'Sala Secondaria' %}selected{% endif %}>Sala Secondaria</option>
                    <option value="Soppalco" {% if collocazione.collocazione_1 == 'Soppalco' %}selected{% endif %}>Soppalco</option>
                </select>

                <label for="collocazione_2_{{ loop.index }}">Collocazione 2</label>
                <select id="collocazione_2_{{ loop.index }}" name="collocazione_2">
                    {% if collocazione.collocazione_1 == 'Sala Principale' %}
                        <option value="Frigo" {% if collocazione.collocazione_2 == 'Frigo' %}selected{% endif %}>Frigo</option>
                        <option value="Scaffali" {% if collocazione.collocazione_2 == 'Scaffali' %}selected{% endif %}>Scaffali</option>
                    {% elif collocazione.collocazione_1 in ['Sala Secondaria', 'Soppalco'] %}
                        <option value="Scaffali" {% if collocazione.collocazione_2 == 'Scaffali' %}selected{% endif %}>Scaffali</option>
                    {% endif %}
                </select>

                <label for="quantita_{{ loop.index }}">Quantità</label>
                <input type="number" id="quantita_{{ loop.index }}" name="quantita" min="1" value="{{ collocazione.quantita }}" required>
            </div>
            {% endfor %}
        </div>

        <button type="button" onclick="aggiungiCollocazione()">Aggiungi Collocazione</button>
        <button type="submit">Salva Modifiche</button>
    </form>
</div>

<script>
    // Funzione per aggiungere una nuova collocazione
    function aggiungiCollocazione() {
        const container = document.getElementById('collocazioni-container');
        const newIndex = container.children.length + 1; // Calcola l'indice per il nuovo elemento

        const newCollocazione = document.createElement('div');
        newCollocazione.classList.add('collocazione-item');

        newCollocazione.innerHTML = `
            <label for="collocazione_1_${newIndex}">Collocazione 1</label>
            <select id="collocazione_1_${newIndex}" name="collocazione_1" onchange="updateCollocazione2(this)">
                <option value="">Seleziona una collocazione</option>
                <option value="Sala Principale">Sala Principale</option>
                <option value="Sala Secondaria">Sala Secondaria</option>
                <option value="Soppalco">Soppalco</option>
            </select>

            <label for="collocazione_2_${newIndex}">Collocazione 2</label>
            <select id="collocazione_2_${newIndex}" name="collocazione_2">
                <option value="">Seleziona una collocazione</option>
            </select>

            <label for="quantita_${newIndex}">Quantità</label>
            <input type="number" id="quantita_${newIndex}" name="quantita" min="1" required>
        `;

        container.appendChild(newCollocazione);
    }

    // Funzione per aggiornare le opzioni di Collocazione 2 in base alla selezione di Collocazione 1
    function updateCollocazione2(selectElement) {
        var collocazione1 = selectElement.value;
        var collocazione2 = selectElement.closest('.collocazione-item').querySelector('select[name="collocazione_2"]');

        // Resetta le opzioni di "Collocazione 2"
        collocazione2.innerHTML = '';

        // Aggiungi opzioni basate sulla selezione di "Collocazione 1"
        if (collocazione1 === 'Sala Principale') {
            collocazione2.add(new Option('Frigo', 'Frigo'));
            collocazione2.add(new Option('Scaffali', 'Scaffali'));
        } else if (collocazione1 === 'Sala Secondaria' || collocazione1 === 'Soppalco') {
            collocazione2.add(new Option('Scaffali', 'Scaffali'));
        }
    }

    // Assegna l'evento onchange a tutte le select di collocazione_1 esistenti
    document.querySelectorAll('select[name="collocazione_1"]').forEach(function(selectElement) {
        selectElement.addEventListener('change', function() {
            updateCollocazione2(selectElement);
        });
    });
</script>
{% endblock %}
